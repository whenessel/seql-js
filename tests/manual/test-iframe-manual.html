<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SEQL.js - Manual Iframe Testing</title>
    <style>
      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        background: #f5f5f5;
        padding: 20px;
      }

      .container {
        max-width: 1400px;
        margin: 0 auto;
      }

      h1 {
        color: #333;
        margin-bottom: 10px;
      }

      .description {
        color: #666;
        margin-bottom: 20px;
        line-height: 1.6;
      }

      .test-panel {
        background: white;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }

      .section-title {
        font-size: 18px;
        font-weight: 600;
        margin-bottom: 15px;
        color: #1a73e8;
      }

      .controls {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        margin-bottom: 15px;
      }

      .btn {
        padding: 10px 16px;
        border: none;
        border-radius: 6px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
      }

      .btn-primary {
        background: #1a73e8;
        color: white;
      }

      .btn-primary:hover {
        background: #1557b0;
      }

      .btn-secondary {
        background: #f1f3f4;
        color: #333;
      }

      .btn-secondary:hover {
        background: #e8eaed;
      }

      .btn-success {
        background: #34a853;
        color: white;
      }

      .btn-success:hover {
        background: #2d8e47;
      }

      .output {
        background: #f8f9fa;
        border: 1px solid #e0e0e0;
        border-radius: 6px;
        padding: 15px;
        font-family: 'Monaco', 'Courier New', monospace;
        font-size: 12px;
        max-height: 300px;
        overflow-y: auto;
        white-space: pre-wrap;
        word-break: break-all;
      }

      .output.empty {
        color: #999;
        font-style: italic;
      }

      .frames-container {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-top: 20px;
      }

      .frame-panel {
        background: white;
        border-radius: 8px;
        padding: 15px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }

      .frame-title {
        font-weight: 600;
        margin-bottom: 10px;
        color: #333;
      }

      .frame-wrapper {
        border: 2px solid #e0e0e0;
        border-radius: 6px;
        overflow: hidden;
        background: white;
      }

      iframe {
        width: 100%;
        height: 500px;
        border: none;
        display: block;
      }

      .main-content {
        padding: 30px;
        background: white;
        border-radius: 6px;
      }

      .main-content h2 {
        color: #1a73e8;
        margin-bottom: 15px;
      }

      .main-content p {
        line-height: 1.6;
        margin-bottom: 10px;
      }

      .main-content button {
        margin: 5px;
      }

      .stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 10px;
        margin-top: 15px;
      }

      .stat-card {
        background: #f8f9fa;
        padding: 12px;
        border-radius: 6px;
        text-align: center;
      }

      .stat-label {
        font-size: 11px;
        color: #666;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .stat-value {
        font-size: 20px;
        font-weight: 700;
        color: #1a73e8;
        margin-top: 5px;
      }

      .success {
        color: #34a853;
      }

      .error {
        color: #ea4335;
      }

      .warning {
        color: #fbbc04;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>üß™ SEQL.js Iframe Support - Manual Testing</h1>
      <p class="description">
        This page demonstrates iframe support in seql-js. The left side contains the main document,
        and the right side contains an iframe with the "Modern Seaside Stay" fixture. Use the
        controls below to test EID generation and SEQL resolution in both contexts.
      </p>

      <!-- Test Controls -->
      <div class="test-panel">
        <div class="section-title">‚ö° Test Controls</div>

        <div class="controls">
          <button class="btn btn-primary" onclick="generateInMain()">Generate EID (Main)</button>
          <button class="btn btn-primary" onclick="generateInIframe()">
            Generate EID (Iframe)
          </button>
          <button class="btn btn-success" onclick="testBothContexts()">Test Both Contexts</button>
          <button class="btn btn-secondary" onclick="clearOutput()">Clear Output</button>
        </div>

        <div class="controls">
          <button class="btn btn-secondary" onclick="countElements()">Count Elements</button>
          <button class="btn btn-secondary" onclick="testResolution()">Test Resolution</button>
          <button class="btn btn-secondary" onclick="testCrossDocument()">
            Test Cross-Document
          </button>
        </div>

        <div class="section-title" style="margin-top: 20px">üìä Results</div>
        <div id="output" class="output empty">No tests run yet. Click a button above to start.</div>

        <div class="stats">
          <div class="stat-card">
            <div class="stat-label">Main Elements</div>
            <div class="stat-value" id="mainCount">0</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Iframe Elements</div>
            <div class="stat-value" id="iframeCount">0</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Success Rate</div>
            <div class="stat-value success" id="successRate">0%</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Last Test Time</div>
            <div class="stat-value" id="testTime">0ms</div>
          </div>
        </div>
      </div>

      <!-- Frames Display -->
      <div class="frames-container">
        <!-- Main Document -->
        <div class="frame-panel">
          <div class="frame-title">üìÑ Main Document</div>
          <div class="frame-wrapper">
            <div class="main-content" id="mainDoc">
              <h2>Welcome to Main Document</h2>
              <p>This is the main document content. Click on any element to generate its EID.</p>

              <form id="testForm" data-testid="main-form">
                <label for="username">Username:</label>
                <input type="text" id="username" name="username" placeholder="Enter username" />

                <label for="email">Email:</label>
                <input type="email" id="email" name="email" placeholder="Enter email" />

                <button type="button" class="btn btn-primary">Submit</button>
                <button type="button" class="btn btn-secondary">Cancel</button>
              </form>

              <nav role="navigation" aria-label="Main navigation">
                <ul>
                  <li><a href="#home">Home</a></li>
                  <li><a href="#about">About</a></li>
                  <li><a href="#contact">Contact</a></li>
                </ul>
              </nav>

              <article>
                <h3>Test Article</h3>
                <p>This is a test article with some content for selector generation.</p>
              </article>
            </div>
          </div>
        </div>

        <!-- Iframe Document -->
        <div class="frame-panel">
          <div class="frame-title">üñºÔ∏è Iframe Document (Modern Seaside Stay)</div>
          <div class="frame-wrapper">
            <iframe id="testIframe" src="../../fixtures/modern-seaside-stay.htm"></iframe>
          </div>
        </div>
      </div>
    </div>

    <!-- Load SEQL.js library -->
    <script src="../../dist/seql-js.umd.cjs"></script>

    <script>
      // Global state
      let testStats = {
        mainCount: 0,
        iframeCount: 0,
        successCount: 0,
        totalTests: 0,
      };

      // Wait for iframe to load
      const iframe = document.getElementById('testIframe');
      let iframeReady = false;

      iframe.addEventListener('load', () => {
        iframeReady = true;
        log('‚úÖ Iframe loaded successfully');
        updateCounts();
      });

      // Utility functions
      function log(message, type = 'info') {
        const output = document.getElementById('output');
        const timestamp = new Date().toLocaleTimeString();
        const prefix =
          type === 'error' ? '‚ùå' : type === 'success' ? '‚úÖ' : type === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è';

        if (output.classList.contains('empty')) {
          output.classList.remove('empty');
          output.textContent = '';
        }

        output.textContent += `[${timestamp}] ${prefix} ${message}\n`;
        output.scrollTop = output.scrollHeight;
      }

      function clearOutput() {
        const output = document.getElementById('output');
        output.textContent = 'Output cleared.';
        output.classList.add('empty');
      }

      function updateStats() {
        const successRate =
          testStats.totalTests > 0
            ? Math.round((testStats.successCount / testStats.totalTests) * 100)
            : 0;

        document.getElementById('successRate').textContent = successRate + '%';
      }

      function updateCounts() {
        const mainElements = document.querySelectorAll('#mainDoc *').length;
        const iframeElements = iframeReady
          ? iframe.contentDocument.querySelectorAll('*').length
          : 0;

        testStats.mainCount = mainElements;
        testStats.iframeCount = iframeElements;

        document.getElementById('mainCount').textContent = mainElements;
        document.getElementById('iframeCount').textContent = iframeElements;
      }

      function countElements() {
        log('Counting elements...');
        updateCounts();
        log(`Main document: ${testStats.mainCount} elements`);
        log(`Iframe document: ${testStats.iframeCount} elements`, 'success');
      }

      // Test functions
      function generateInMain() {
        const startTime = performance.now();
        log('Generating EID in main document...');

        try {
          const button = document.querySelector('#mainDoc button');
          const eid = SeqlJS.generateEID(button);
          const seql = SeqlJS.generateSEQL(button);

          if (eid && seql) {
            log(`EID generated successfully for: ${button.textContent}`, 'success');
            log(`SEQL: ${seql}`);
            log(`Confidence: ${(eid.meta.confidence * 100).toFixed(1)}%`);
            log(`Anchor: ${eid.anchor.tag}, Target: ${eid.target.tag}`);

            testStats.successCount++;
          } else {
            log('Failed to generate EID', 'error');
          }

          testStats.totalTests++;
          const elapsed = performance.now() - startTime;
          document.getElementById('testTime').textContent = elapsed.toFixed(2) + 'ms';
          updateStats();
        } catch (error) {
          log(`Error: ${error.message}`, 'error');
          testStats.totalTests++;
          updateStats();
        }
      }

      function generateInIframe() {
        if (!iframeReady) {
          log('Iframe not ready yet. Please wait...', 'warning');
          return;
        }

        const startTime = performance.now();
        log('Generating EID in iframe document...');

        try {
          const iframeDoc = iframe.contentDocument;
          const button = iframeDoc.querySelector('button');

          if (!button) {
            log('No button found in iframe', 'warning');
            return;
          }

          // Pass iframe's contentDocument as root
          const eid = SeqlJS.generateEID(button, { root: iframeDoc });
          const seql = SeqlJS.generateSEQL(button, { root: iframeDoc });

          if (eid && seql) {
            log(`EID generated successfully for iframe element`, 'success');
            log(`SEQL: ${seql}`);
            log(`Confidence: ${(eid.meta.confidence * 100).toFixed(1)}%`);
            log(`Anchor: ${eid.anchor.tag}, Target: ${eid.target.tag}`);

            testStats.successCount++;
          } else {
            log('Failed to generate EID', 'error');
          }

          testStats.totalTests++;
          const elapsed = performance.now() - startTime;
          document.getElementById('testTime').textContent = elapsed.toFixed(2) + 'ms';
          updateStats();
        } catch (error) {
          log(`Error: ${error.message}`, 'error');
          testStats.totalTests++;
          updateStats();
        }
      }

      function testBothContexts() {
        log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
        log('Running tests in both contexts...');
        log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');

        generateInMain();

        setTimeout(() => {
          generateInIframe();
          log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
          log('Both context tests completed', 'success');
          log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
        }, 100);
      }

      function testResolution() {
        if (!iframeReady) {
          log('Iframe not ready yet. Please wait...', 'warning');
          return;
        }

        log('Testing SEQL resolution...');

        try {
          // Test in main document
          const mainButton = document.querySelector('#mainDoc button');
          const mainSeql = SeqlJS.generateSEQL(mainButton);
          const mainResolved = SeqlJS.resolveSEQL(mainSeql, document);

          log(`Main document - Generated: ${mainSeql}`);
          log(
            `Main document - Resolved: ${mainResolved.length} element(s)`,
            mainResolved.length === 1 ? 'success' : 'warning'
          );

          // Test in iframe
          const iframeDoc = iframe.contentDocument;
          const iframeButton = iframeDoc.querySelector('button');
          let iframeResolved = [];

          if (iframeButton) {
            const iframeSeql = SeqlJS.generateSEQL(iframeButton, { root: iframeDoc });
            iframeResolved = SeqlJS.resolveSEQL(iframeSeql, iframeDoc);

            log(`Iframe document - Generated: ${iframeSeql}`);
            log(
              `Iframe document - Resolved: ${iframeResolved.length} element(s)`,
              iframeResolved.length === 1 ? 'success' : 'warning'
            );
          }

          testStats.totalTests += 2;
          testStats.successCount +=
            (mainResolved.length === 1 ? 1 : 0) +
            (iframeButton && iframeResolved.length === 1 ? 1 : 0);
          updateStats();
        } catch (error) {
          log(`Error: ${error.message}`, 'error');
        }
      }

      function testCrossDocument() {
        if (!iframeReady) {
          log('Iframe not ready yet. Please wait...', 'warning');
          return;
        }

        log('Testing cross-document error handling...');

        try {
          const mainButton = document.querySelector('#mainDoc button');
          const iframeDoc = iframe.contentDocument;

          // This should fail with a helpful error message
          log('Attempting cross-document generation (should fail)...');
          const eid = SeqlJS.generateEID(mainButton, { root: iframeDoc });

          if (!eid) {
            log('Cross-document generation correctly rejected', 'success');
            testStats.successCount++;
          } else {
            log('Cross-document generation should have failed!', 'error');
          }

          testStats.totalTests++;
          updateStats();
        } catch (error) {
          log(`Expected error caught: ${error.message}`, 'success');
          testStats.totalTests++;
          testStats.successCount++;
          updateStats();
        }
      }

      // Add click handlers to main document elements
      document.getElementById('mainDoc').addEventListener('click', (e) => {
        if (e.target.tagName !== 'BUTTON' || e.target.closest('.controls')) return;

        const eid = SeqlJS.generateEID(e.target);
        const seql = SeqlJS.generateSEQL(e.target);

        log(`Clicked element: ${e.target.textContent}`);
        log(`SEQL: ${seql}`);
      });

      // Initialize
      window.addEventListener('load', () => {
        log('Page loaded. SEQL.js ready.');
        updateCounts();
      });
    </script>
  </body>
</html>
